rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if a user is an admin
    function isAdmin() {
      return get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // Workers can only be read by their own user or an admin.
    // Workers can only be updated by their own user or an admin.
    // New workers can be created by anyone (during signup).
    match /workers/{workerId} {
      allow read, update: if request.auth != null && (request.auth.uid == resource.data.authUid || isAdmin());
      allow create: if request.auth != null;
      allow delete: if isAdmin();

      // Daily entries can only be accessed by the worker they belong to, or an admin.
      match /dailyEntries/{entryId} {
        allow read, write: if request.auth != null && (request.auth.uid == get(/databases/$(database)/documents/workers/$(workerId)).data.authUid || isAdmin());
      }
    }
    
    // Categories, Notifications, Investments, SliderItems, Settings can be read by any authenticated user.
    // Only admins can create, update, or delete them.
    match /{collection}/{docId} 
      where collection in ['categories', 'notifications', 'investments', 'sliderItems', 'settings', 'admins', 'counters'] {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // Chat messages can be read/written by the participants or admin.
    match /chats/{chatId}/messages/{messageId} {
       allow read, write: if request.auth != null; // Simplified for now, can be restricted to chat participants
    }

    // Entry requests can be created by authenticated users.
    // They can be read, updated, or deleted by admins.
    match /entryRequests/{requestId} {
      allow create: if request.auth != null;
      allow list, read, update, delete: if isAdmin();
    }
    
    // Money requests can be created by authenticated users.
    // Admins can read, update, or delete them.
    // Workers can read their own requests.
    match /moneyRequests/{requestId} {
      allow create: if request.auth != null;
      allow list, read, update, delete: if isAdmin() || (request.auth != null && request.auth.uid == resource.data.authUid);
    }
  }
}
